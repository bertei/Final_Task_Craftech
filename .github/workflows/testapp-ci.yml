name: TestApp-CI

on:
  push:
    branches:
      - dev

jobs:
  DockerImage-Build-Push:
    runs-on: ubuntu-latest ##runner OS
    steps:
      - name: Checkout ##runner git clone
        uses: actions/checkout@v3
      - name: Set up QEMU ##used to provide emulated environments for builiding on architecture other than the host arch
        uses: docker/setup-qemu-action@v2
      - name: Login to Dockerhub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Build Backend Image and Push to Dockerhub
        uses: docker/build-push-action@v3
        with:
          file: ./test-app-backend/Dockerfile
          context: .
          push: true
          tags: bernaa77/testapp-backend:latest
      - name: Build Frontend Image and Push to Dockerhub
        uses: docker/build-push-action@v3
        with:
          file: ./test-app-frontend/Dockerfile
          context: .
          push: true
          tags: bernaa77/testapp-frontend:latest
  Minikube-Helm-Setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Minikube Setup
        uses: medyagh/setup-minikube@master
      #- name: Minikube Ingress addon installation
      #  run: minikube addons enable ingress
      - name: Helm Setup
        uses: azure/setup-helm@v3
        with:
          version: '3.9.0'
      - name: Set up etc/hosts
        run : |
          sudo echo "127.0.0.1 testapp.dev" | sudo tee -a /etc/hosts
      - name: Install Helm Chart
        run:  ./testapp-chart-dynamic/helm_install.sh

